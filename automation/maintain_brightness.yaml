##############################################################################
###  Maintain Brightness
##############################################################################
##############################################################################
#		As coded by @Skalavala and helped to completion by @Dale3h
#		Allows a room's brightness levels to be maintained,
#		regardless of number of lights turned on
##############################################################################

##############################################################################
###  Maintain Brightness in the Bedroom
##############################################################################


- alias: Maintain Brightness Bedroom
  trigger:

    - platform: state
      entity_id: light.bedroom_main_light
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.bedroom_main_light
      from: 'off'
      to: 'on'

    - platform: state
      entity_id: light.jack_bedside_light
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.jack_bedside_light
      from: 'off'
      to: 'on'

    - platform: state
      entity_id: light.lara_bedside_light
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.lara_bedside_light
      from: 'off'
      to: 'on'

  action:
    - service_template: >-
        {% macro getlight_count() %}
          {% set count = 0 %}
          {% if is_state('light.bedroom_main_light', 'on') %}
            {% set count = count + 2 %}
          {% endif %}
          {% if is_state('light.jack_bedside_light', 'on') %}
            {% set count = count + 1 %}
          {% endif %}
          {% if is_state('light.lara_bedside_light', 'on') %}
            {% set count = count + 1 %}
          {% endif %}
          {{ count }}
        {% endmacro %}

        {% set count = getlight_count() %}
        {% if count == 0 %}
          light.turn_off
        {% else %}
          light.turn_on
        {% endif %}

#      data_template:
#        entity_id: >-
#          {% set comma = joiner() %}
#          {%- if is_state('light.bedroom_main_light', 'on') -%}
#            {{- comma() -}}
#            light.bedroom_main_light
#          {%- endif -%}
#          {%- if is_state('light.jack_bedside_light', 'on') -%}
#            {{- comma() -}}
#            light.jack_bedside_light
#          {%- endif -%}
#          {%- if is_state('light.lara_bedside_light', 'on') -%}
#            {{- comma() -}}
#            light.lara_bedside_light
#          {%- endif -%}

      data_template:
        entity_id: >-
          {% set lights = [
          	'light.bedroom_main_light',
            'light.jack_bedside_light',
            'light.lara_bedside_light'
          ] %}
          {% set comma = joiner(',') %}
          {%- for light in lights if is_state(light, 'on') -%}
            {{ comma() }}{{ light }}
          {%- endfor -%}

        brightness: >-
          {% macro getlight_count() %}
            {% set count = 0 %}
            {% if is_state('light.bedroom_main_light', 'on') %}
              {% set count = count + 2 %}
            {% endif %}
            {% if is_state('light.jack_bedside_light', 'on') %}
              {% set count = count + 1 %}
            {% endif %}
            {% if is_state('light.lara_bedside_light', 'on') %}
              {% set count = count + 1 %}
            {% endif %}
            {{ count }}
          {% endmacro %}

          {% macro getlight_level() %}
            {% set level = 0 %}
            {% set hour=states("sensor.time").split(':')[0] | int %}
            {%- if hour >= 5 and hour < 8  -%}
              {% set level = 150 %}
            {%- elif hour >= 8 and hour <20  -%}
              {% set level = 350 %}
            {%- elif hour >= 20 and hour <24  -%}
              {% set level = 150 %}
            {%- else -%}
              {% set level = 60 %}
            {%- endif %}
            {{ level }}
          {% endmacro %}

          {% set count = getlight_count()|int %}
          {% set level = getlight_level()|int %}
          {% if count == 4 %}
            {{ ( level // 4 |int ) }}
          {% elif count == 3 %}
            {{ ( level // 3 |int ) }}
          {% elif count == 2 %}
            {{ ( level // 2 |int ) }}
          {% elif count == 1 %}
            {{ ( level // 1 |int ) }}
          {% else %}
            0
          {% endif %}


##############################################################################
###  Maintain Brightness in the Living Room
##############################################################################


- alias: Maintain Brightness Living Room
  trigger:

    - platform: state
      entity_id: light.living_room_lamp
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.living_room_lamp
      from: 'off'
      to: 'on'

    - platform: state
      entity_id: light.living_room_main_light
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.living_room_main_light
      from: 'off'
      to: 'on'

    - platform: state
      entity_id: light.living_room_side_lights
      from: 'on'
      to: 'off'
    - platform: state
      entity_id: light.living_room_side_lights
      from: 'off'
      to: 'on'

  action:
    - service_template: >-
        {% macro getlight_count() %}
          {% set count = 0 %}
          {% if is_state('light.living_room_lamp', 'on') %}
            {% set count = count + 1 %}
          {% endif %}
          {% if is_state('light.living_room_main_light', 'on') %}
            {% set count = count + 2 %}
          {% endif %}
          {% if is_state('light.living_room_side_lights', 'on') %}
            {% set count = count + 2 %}
          {% endif %}
          {{ count }}
        {% endmacro %}

        {% set count = getlight_count() %}
        {% if count == 0 %}
          light.turn_off
        {% else %}
          light.turn_on
        {% endif %}


      data_template:
        entity_id: >-
          {% set lights = [
          	'light.living_room_lamp',
            'light.living_room_main_light',
            'light.living_room_side_lights'
          ] %}
          {% set comma = joiner(',') %}
          {%- for light in lights if is_state(light, 'on') -%}
            {{ comma() }}{{ light }}
          {%- endfor %}

        brightness: >-
          {% macro getlight_count() %}
            {% set count = 0 %}
            {% if is_state('light.living_room_lamp', 'on') %}
              {% set count = count + 1 %}
            {% endif %}
            {% if is_state('light.living_room_main_light', 'on') %}
              {% set count = count + 2 %}
            {% endif %}
            {% if is_state('light.living_room_side_lights', 'on') %}
              {% set count = count + 2 %}
            {% endif %}
            {{ count }}
          {% endmacro %}

          {% macro getlight_level() %}
            {% set level = 0 %}
            {% set hour=states("sensor.time").split(':')[0] | int %}
            {%- if hour >= 5 and hour < 8  -%}
              {% set level = 150 %}
            {%- elif hour >= 8 and hour <20  -%}
              {% set level = 350 %}
            {%- elif hour >= 20 and hour <24  -%}
              {% set level = 150 %}
            {%- else -%}
              {% set level = 60 %}
            {%- endif %}
            {{ level }}
          {% endmacro %}

          {% set count = getlight_count()|int %}
          {% set level = getlight_level()|int %}
          {% if count == 5 %}
            {{ ( level // 5 |int ) }}
          {% elif count == 4 %}
            {{ ( level // 4 |int ) }}
          {% elif count == 3 %}
            {{ ( level // 3 |int ) }}
          {% elif count == 2 %}
            {{ ( level // 2 |int ) }}
          {% elif count == 1 %}
            {{ ( level // 1 |int ) }}
          {% else %}
            0
          {% endif %}
